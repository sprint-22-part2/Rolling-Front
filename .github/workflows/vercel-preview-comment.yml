name: Vercel Preview Comment

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check eligibility
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const base = context.payload.pull_request.base.ref;
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const assoc = context.payload.pull_request.author_association;
            const author = context.payload.pull_request.user.login;
            core.info(`base: ${base}`);
            core.info(`labels: ${labels.join(', ')}`);
            core.info(`author_association: ${assoc}`);
            core.info(`author: ${author}`);
            const allowedAuthors = new Set([
              'Lseojeong',
              'bitna0a',
              'geniexx64',
              'ziy1027',
            ]);
            const allowed =
              base === 'develop' &&
              labels.includes('ðŸ”Ž Preview') &&
              allowedAuthors.has(author);
            core.setOutput('allowed', allowed ? 'true' : 'false');

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Deploy to Vercel (Preview)
        id: vercel
        uses: amondnet/vercel-action@v25
        if: steps.guard.outputs.allowed == 'true'
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: ''
          scope: ${{ secrets.VERCEL_TEAM_SCOPE }}

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        if: steps.guard.outputs.allowed == 'true'
        with:
          script: |
            const url = '${{ steps.vercel.outputs.preview-url }}';
            if (!url) {
              core.setFailed('Preview URL not found from Vercel action.');
              return;
            }
            const body = `ðŸŽ‰ êµ¬í˜„í•œ ê¸°ëŠ¥ Preview: ${url}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
